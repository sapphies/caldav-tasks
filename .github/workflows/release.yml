name: 'publish'

on:
  workflow_dispatch:
  push:
    branches:
      - release

# ensure only one release workflow runs at a time
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # first job: generate changelog and create the release
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Get previous tag
        id: get_prev_tag
        run: |
          # Get the most recent tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "prev_tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG="${{ steps.get_prev_tag.outputs.prev_tag }}"

          if [ -z "$PREV_TAG" ]; then
            # No previous tag, get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges HEAD)
          else
            # Get commits since last tag
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREV_TAG}..HEAD)
          fi

          # Categorize commits by conventional commit type
          FEATURES=""
          FIXES=""
          OTHERS=""

          while IFS= read -r line; do
            if [[ "$line" == *"feat:"* ]] || [[ "$line" == *"feat("* ]]; then
              FEATURES="${FEATURES}${line}"$'\n'
            elif [[ "$line" == *"fix:"* ]] || [[ "$line" == *"fix("* ]]; then
              FIXES="${FIXES}${line}"$'\n'
            elif [[ -n "$line" ]]; then
              OTHERS="${OTHERS}${line}"$'\n'
            fi
          done <<< "$COMMITS"

          # Build changelog with proper newlines
          CHANGELOG=""

          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}## âœ¨ Features"$'\n\n'"${FEATURES}"$'\n'
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}## ðŸ› Bug Fixes"$'\n\n'"${FIXES}"$'\n'
          fi

          if [ -n "$OTHERS" ]; then
            CHANGELOG="${CHANGELOG}## ðŸ“ Other Changes"$'\n\n'"${OTHERS}"$'\n'
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No notable changes in this release."
          fi

          # Add download instructions
          CHANGELOG="${CHANGELOG}---"$'\n\n'"ðŸ“¥ **Download the appropriate installer for your platform from the assets below.**"

          # Use heredoc syntax for multiline output
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: app-v${{ steps.get_version.outputs.version }}
          release_name: caldav-tasks v${{ steps.get_version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: true
          prerelease: false

  # second job: Build and upload artifacts for each platform
  publish-tauri:
    needs: prepare-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-15-intel'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''
          # Use the native ARM runner (available for public repos)
          - platform: 'ubuntu-22.04-arm'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      # Updated condition to catch both 'ubuntu-22.04' and 'ubuntu-22.04-arm'
      - name: install dependencies (ubuntu only)
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup2.4-dev libssl-dev libgtk-3-dev libjavascriptcoregtk-4.0-dev xdg-utils

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # Fix for EGL_BAD_PARAMETER issue on Linux AppImage
      # This fixes blank screen on launch caused by outdated linuxdeploy bundled with Tauri CLI.
      # The issue is related to webkitgtk compatibility.
      # See: https://github.com/tauri-apps/tauri/pull/12491
      - name: Install tauri-cli with new AppImage format (Linux)
        if: startsWith(matrix.platform, 'ubuntu')
        run: cargo install tauri-cli --git https://github.com/tauri-apps/tauri --branch feat/truly-portable-appimage

      - name: install frontend dependencies
        run: pnpm install

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Use new truly portable AppImage format for Linux builds
          # See: https://github.com/tauri-apps/tauri/pull/12491
          TAURI_BUNDLER_NEW_APPIMAGE_FORMAT: ${{ startsWith(matrix.platform, 'ubuntu') && 'true' || 'false' }}
        with:
          # use existing release created by prepare-release job
          releaseId: ${{ needs.prepare-release.outputs.release_id }}
          args: ${{ matrix.args }}
